<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chiptune SFX Soundboard</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 18px;
      background: #0f1117;
      color: #e7eaf0;
    }
    h1 {
      margin: 0 0 6px;
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 10px 0;
      align-items: center;
    }
    button {
      padding: 10px 12px;
      border: 0;
      border-radius: 10px;
      background: #2a3142;
      color: #e7eaf0;
      cursor: pointer;
    }
    button:hover {
      background: #39425a;
    }
    button.primary {
      background: #3b62ff;
    }
    button.primary:hover {
      background: #2f56f0;
    }
    label {
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }
    select,
    input {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #3a4256;
      background: #141827;
      color: #e7eaf0;
    }
    input[type="range"] {
      padding: 0;
    }
    textarea {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #3a4256;
      background: #141827;
      color: #e7eaf0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      resize: vertical;
      width: 100%;
    }
    .panel {
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 14px;
      padding: 14px;
      background: rgba(255, 255, 255, 0.04);
    }
    .event-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .muted {
      color: rgba(231, 234, 240, 0.65);
    }
    .error {
      color: #fca5a5;
    }
    code {
      color: #b7c6ff;
    }
  </style>
</head>
<body>
  <h1>Chiptune SFX Soundboard</h1>
  <div class="muted">Pick a bank, unlock audio, then press buttons to test SFX.</div>

  <div class="panel" style="margin-top: 14px;">
    <div class="row">
      <button id="unlock" class="primary">Unlock / Enable Audio</button>

      <label>
        Bank
        <select id="bank">
          <option value="PP">Puzzle Puncher</option>
          <option value="PLOP">Plop Plop</option>
          <option value="PILL">Pill Popper</option>
        </select>
      </label>

      <label>
        Master
        <input id="master" type="range" min="0" max="1" step="0.01" value="0.60">
      </label>

      <label>
        <input id="enabled" type="checkbox" checked> Enabled
      </label>
    </div>

    <div class="row">
      <label>chain <input id="chain" type="number" min="1" max="20" value="2" style="width: 76px;"></label>
      <label>cleared <input id="cleared" type="number" min="0" max="60" value="8" style="width: 76px;"></label>
      <label>viruses <input id="viruses" type="number" min="0" max="6" value="2" style="width: 76px;"></label>
      <label>power <input id="power" type="number" min="0" max="20" value="2" style="width: 76px;"></label>
      <span class="muted">(payload fields are optional; banks ignore what they do not use)</span>
    </div>

    <label style="display: block; margin-top: 8px;">
      Payload (JSON)
      <textarea id="payload-json" rows="3">{}</textarea>
    </label>
    <div id="payload-error" class="muted" style="margin-top: 4px;"></div>

    <div id="bank-info" class="muted" style="margin-top: 10px;"></div>
    <div id="sfx-buttons" class="event-grid" style="margin-top: 8px;"></div>

    <div class="muted" style="margin-top: 10px;">
      Tip: If you do not hear anything, click <code>Unlock / Enable Audio</code> again.
    </div>
  </div>

  <script type="module">
    import { SfxEngine } from './sfx_engine.js';
    import { BANK_PUZZLEPUNCHER } from './sfx_bank_puzzle_puncher.js';
    import { BANK_PLOPPLOP } from './sfx_bank_plop_plop.js';
    import { BANK_PILLPOPPER } from './sfx_bank_pill_popper.js';

    const sfx = new SfxEngine({ master: 0.6 });

    const elUnlock = document.querySelector('#unlock');
    const elBank = document.querySelector('#bank');
    const elMaster = document.querySelector('#master');
    const elEnabled = document.querySelector('#enabled');
    const elChain = document.querySelector('#chain');
    const elCleared = document.querySelector('#cleared');
    const elViruses = document.querySelector('#viruses');
    const elPower = document.querySelector('#power');
    const elPayloadJson = document.querySelector('#payload-json');
    const elPayloadError = document.querySelector('#payload-error');
    const elButtons = document.querySelector('#sfx-buttons');
    const elBankInfo = document.querySelector('#bank-info');

    function currentBank() {
      switch (elBank.value) {
        case 'PP':
          return BANK_PUZZLEPUNCHER;
        case 'PLOP':
          return BANK_PLOPPLOP;
        case 'PILL':
        default:
          return BANK_PILLPOPPER;
      }
    }

    function readJsonPayload() {
      const text = elPayloadJson.value.trim();
      if (!text) {
        elPayloadError.textContent = '';
        elPayloadError.classList.remove('error');
        return {};
      }
      try {
        const parsed = JSON.parse(text);
        if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {
          elPayloadError.textContent = '';
          elPayloadError.classList.remove('error');
          return parsed;
        }
      } catch (err) {
        // fall through to error below
      }
      elPayloadError.textContent = 'Invalid JSON payload (using quick fields only).';
      elPayloadError.classList.add('error');
      return {};
    }

    function payload() {
      const base = {
        chain: Number(elChain.value) || 1,
        chainIndex: Number(elChain.value) || 1,
        cleared: Number(elCleared.value) || 0,
        viruses: Number(elViruses.value) || 0,
        power: Number(elPower.value) || 0,
      };
      return { ...base, ...readJsonPayload() };
    }

    function renderButtons() {
      const bank = currentBank();
      const keys = Object.keys(bank ?? {});
      elButtons.innerHTML = '';
      if (!keys.length) {
        elBankInfo.textContent = 'No events found in this bank.';
        return;
      }
      elBankInfo.textContent = `Events in bank: ${keys.length}`;
      keys.forEach((name) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.setAttribute('data-sfx', name);
        btn.textContent = name;
        elButtons.appendChild(btn);
      });
    }

    elUnlock.addEventListener('click', () => {
      sfx.unlock();
    });

    elMaster.addEventListener('input', () => {
      sfx.setMaster(elMaster.value);
    });

    elEnabled.addEventListener('change', () => {
      sfx.setEnabled(elEnabled.checked);
    });

    elPayloadJson.addEventListener('input', () => {
      readJsonPayload();
    });

    elBank.addEventListener('change', () => {
      renderButtons();
    });

    elButtons.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-sfx]');
      if (!btn) return;
      const name = btn.getAttribute('data-sfx');
      sfx.play(currentBank(), name, payload());
    });

    window.addEventListener('keydown', (e) => {
      if (e.repeat) return;
      if (e.key === ' ') {
        sfx.play(currentBank(), 'lock', payload());
        e.preventDefault();
      }
      if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
        sfx.play(currentBank(), 'move', payload());
      }
      if (e.key === 'ArrowUp') {
        sfx.play(currentBank(), 'rotate', payload());
      }
      if (e.key.toLowerCase() === 'c') {
        sfx.play(currentBank(), 'clear', payload());
      }
      if (e.key.toLowerCase() === 'x') {
        sfx.play(currentBank(), 'chain', payload());
      }
      if (e.key.toLowerCase() === 'g') {
        sfx.play(currentBank(), 'gameOver', payload());
      }
    });

    window.addEventListener('pointerdown', () => sfx.unlock(), { once: true });

    renderButtons();
  </script>
</body>
</html>
